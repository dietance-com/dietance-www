<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Success Stories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;700&display=swap');
        body {
            font-family: "Inter", sans-serif;
            background-color: #fbfaf7;
            color: #4a4a4a;
        }
        .review-card {
            min-height: 150px;
        }
        .loading-spinner {
            border-top-color: #5a809b;
            animation: spin 1s infinite linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .font-serif-custom {
            font-family: 'Lora', serif;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-content.show {
            opacity: 1;
            transform: translateY(0);
        }

        .text-green-custom {
            color: #5a809b;
        }
        .bg-green-custom {
            background-color: #5a809b;
        }
        .border-green-custom {
            border-color: #5a809b;
        }
        .hover-bg-green-custom:hover {
            background-color: #4a6a82;
        }
        .hover-text-green-custom:hover {
            color: #4a6a82;
        }
    </style>
</head>
<body class="bg-[#fbfaf7] flex flex-col items-center">
    
    <div class="w-full max-w-7xl p-6 md:p-10 relative">
        <div class="mb-6">
            <a href="index.html" onclick="window.history.back()" class="inline-flex items-center text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </a>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-8 font-serif-custom">Success Stories</h1>
        
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
            <div class="flex items-center gap-2">
                <label for="tag-filter" class="text-gray-700">Tag:</label>
                <input type="text" id="tag-filter" placeholder="e.g., diabetes" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5a809b]"/>
            </div>
            <button id="filter-btn" class="bg-[#5a809b] text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-[#4a6a82] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#5a809b]">
                Filter
            </button>
            <button id="reset-btn" class="bg-[#e0e0e0] text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-[#d0d0d0] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#5a809b]">
                Show All
            </button>
        </div>

        <main id="review-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </main>

        <div id="loading" class="mt-8 flex flex-col items-center justify-center">
            <div class="loading-spinner h-10 w-10 rounded-full border-4 border-gray-300 border-t-green-custom"></div>
            <p class="mt-2 text-lg text-gray-600">Loading stories...</p>
        </div>
        
        <div id="no-more" class="mt-8 text-center text-gray-600 hidden">
            <p class="text-lg">All caught up! No more stories to show. Go get a plan!</p>
        </div>
        
    </div>

    <div id="reviewModal" class="modal-overlay" onclick="closeReviewModal(event)">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <div class="flex justify-end">
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 transition-colors duration-200 text-3xl font-bold p-2 leading-none" onclick="closeReviewModal(event)">
                    &times;
                </button>
            </div>
            <div id="modal-body" class="p-4 md:p-6">
                </div>
        </div>
    </div>

    <script>
        const reviewContainer = document.getElementById('review-container');
        const loading = document.getElementById('loading');
        const noMore = document.getElementById('no-more');
        const reviewModal = document.getElementById('reviewModal');
        const modalBody = document.getElementById('modal-body');
        const tagFilter = document.getElementById('tag-filter');
        const filterBtn = document.getElementById('filter-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        let allReviews = [];
        let filteredReviews = [];
        let dataIsLoading = false;
        let currentReviewIndex = 0;
        const reviewsPerPage = 6;
        const baseUrl = 'assets/stories/';

        function parseDate(dateStr) {
            const parts = dateStr.split(' ');
            const month = parts[0].toUpperCase();
            const year = parseInt(parts[2], 10);
            return { month, year };
        }

        function parseMarkdownReview(markdown) {
            const lines = markdown.trim().split('\n').filter(line => line.trim() !== '');
            
            const title = lines[0] ? lines[0].replace('#', '').trim() : '';
            const date = lines[1] ? lines[1].replace('##', '').trim() : '';
            const author = lines[2] ? lines[2].replace('###', '').trim() : '';
            
            let tags = [];
            const lastLine = lines[lines.length - 1];
            if (lastLine && lastLine.startsWith('TAGS:')) {
                tags = lastLine.replace('TAGS:', '').trim().split(/\s+/).filter(Boolean);
            }
            
            let messageLines = lines.slice(3);
            if (tags.length > 0) {
                messageLines = messageLines.slice(0, -1);
            }
            
            const message = messageLines.join('\n').trim();

            return { title, date, author, message, tags };
        }
        
        async function findHighestReviewIndex() {
            let index = 1;
            while (true) {
                try {
                    const response = await fetch(`${baseUrl}${index}.md`);
                    if (!response.ok) {
                        break;
                    }
                    index++;
                } catch (error) {
                    console.error('Fetch error:', error);
                }
            }
            return index - 1;
        }

        async function loadAllReviews() {
            dataIsLoading = true;
            loading.style.display = 'flex';
            noMore.style.display = 'none';
            reviewContainer.innerHTML = '';

            const highestIndex = await findHighestReviewIndex();
            let allFetchedReviews = [];

            for (let i = highestIndex; i >= 1; i--) {
                const url = `${baseUrl}${i}.md`;
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const markdown = await response.text();
                        const review = parseMarkdownReview(markdown);
                        allFetchedReviews.push(review);
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                }
            }
            allReviews = allFetchedReviews;
            applyFilters();
        }

        function applyFilters() {
            const selectedTag = tagFilter.value.toLowerCase().trim();

            filteredReviews = allReviews.filter(review => {
                const tagMatch = !selectedTag || review.tags.some(tag => tag.toLowerCase().includes(selectedTag));
                return tagMatch;
            });

            // Reset display
            reviewContainer.innerHTML = '';
            currentReviewIndex = 0;
            displayMoreReviews();
        }

        function displayMoreReviews() {
            loading.style.display = 'flex';
            const end = currentReviewIndex + reviewsPerPage;
            const reviewsToDisplay = filteredReviews.slice(currentReviewIndex, end);

            if (reviewsToDisplay.length === 0) {
                loading.style.display = 'none';
                if (currentReviewIndex === 0) { // Only show "no more" if no reviews were found
                    noMore.style.display = 'block';
                }
                window.removeEventListener('scroll', handleScroll);
                return;
            }

            reviewsToDisplay.forEach(review => createReviewCard(review));
            currentReviewIndex = end;

            loading.style.display = 'none';
            dataIsLoading = false;

            // After loading, check if the page is full. If not, load more reviews.
            // This is the key change for desktop.
            checkIfMoreReviewsNeeded();
            
            // Add or remove scroll listener based on whether there are more reviews to load
            if (currentReviewIndex < filteredReviews.length) {
                window.addEventListener('scroll', handleScroll);
            } else {
                noMore.style.display = 'block';
                window.removeEventListener('scroll', handleScroll);
            }
        }
        
        function checkIfMoreReviewsNeeded() {
            // A slight delay to allow the browser to render the new cards and update scrollHeight
            setTimeout(() => {
                const { scrollHeight, clientHeight } = document.documentElement;
                // Load more if there are reviews left and no scrollbar yet
                if (currentReviewIndex < filteredReviews.length && scrollHeight <= clientHeight + 10) {
                    displayMoreReviews();
                }
            }, 100);
        }

        function createReviewCard(review) {
            const card = document.createElement('div');
            card.className = "review-card bg-white rounded-xl shadow-lg p-6 md:p-8 w-full transition-all duration-300 hover:shadow-xl border border-gray-200 cursor-pointer";
            
            const tagsHtml = review.tags.map(tag => `<span class="bg-[#e0e0e0] text-gray-800 text-xs font-semibold px-2 py-1 rounded-full">${tag}</span>`).join(' ');

            card.innerHTML = `
                <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-custom flex-shrink-0 mr-4 mt-1" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10c.85 0 1.67-.14 2.44-.4s1.46-.66 2.09-1.29l2.83 2.83a.75.75 0 0 0 1.06 0 .75.75 0 0 0 0-1.06l-2.83-2.83a10.012 10.012 0 0 0 1.29-2.09c.26-.77.4-1.59.4-2.44A10 10 0 0 0 12 2zm0 1.5a8.5 8.5 0 0 1 8.5 8.5c0 .73-.1.54-.28 1.14-.14.47-.35.8-.57 1.15-.3.49-.6.94-.97 1.34s-.85.8-1.34 1.13c-.47.28-.8.35-1.15.57-.49.3-.94.6-1.34.97-.87.58-1.52.92-2.13 1.13-.61.21-.99.31-1.38.31a8.5 8.5 0 0 1-8.5-8.5A8.5 8.5 0 0 1 12 3.5zm-2.5 5A1.5 1.5 0 0 1 11 10a1.5 1.5 0 0 1-1.5 1.5 1.5 1.5 0 0 1-1.5-1.5A1.5 1.5 0 0 1 8.5 8.5zm5 0A1.5 1.5 0 0 1 16 10a1.5 1.5 0 0 1-1.5 1.5 1.5 1.5 0 0 1-1.5-1.5A1.5 1.5 0 0 1 13.5 8.5z" />
                    </svg>
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800 mb-2 font-serif-custom">${review.title}</h3>
                        <p class="mt-1 text-sm text-gray-500">${review.date}</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                           ${tagsHtml}
                        </div>
                        <p class="mt-4 text-sm text-[#5a809b] font-semibold">- ${review.author}</p>
                    </div>
                </div>
            `;
            reviewContainer.appendChild(card);

            // Add an event listener to the card to open the modal
            card.addEventListener('click', () => {
                showReviewModal(review);
            });
        }

        function showReviewModal(review) {
            const messageAsHtml = marked.parse(review.message);
            const tagsHtml = review.tags.map(tag => `<span class="bg-[#e0e0e0] text-gray-800 text-xs font-semibold px-2 py-1 rounded-full">${tag}</span>`).join(' ');

            // Populate the modal with the review content
            modalBody.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-800 mb-4 font-serif-custom">${review.title}</h2>
                <div class="flex flex-wrap gap-2 mb-4">
                    ${tagsHtml}
                </div>
                <div class="prose max-w-none text-gray-600 leading-relaxed text-base mb-6">
                    ${messageAsHtml}
                </div>
                <p class="text-sm text-[#5a809b] font-semibold text-right">- ${review.author}</p>
            `;
            
            // Show the modal with a fade-in effect
            reviewModal.style.display = 'flex';
            setTimeout(() => {
                reviewModal.classList.add('show');
                reviewModal.querySelector('.modal-content').classList.add('show');
            }, 10);
            
            // Disable scrolling on the body
            document.body.style.overflow = 'hidden';
        }

        function closeReviewModal(event) {
            if (event.target === reviewModal || event.target.closest('#closeModalBtn')) {
                reviewModal.classList.remove('show');
                reviewModal.querySelector('.modal-content').classList.remove('show');

                setTimeout(() => {
                    reviewModal.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeReviewModal({ target: reviewModal });
            }
        });

        function isAtBottom() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            return scrollTop + clientHeight >= scrollHeight - 100;
        }

        function handleScroll() {
            if (isAtBottom() && !dataIsLoading && currentReviewIndex < filteredReviews.length) {
                displayMoreReviews();
            }
        }
        
        filterBtn.addEventListener('click', applyFilters);
        resetBtn.addEventListener('click', () => {
            tagFilter.value = '';
            applyFilters();
        });

        window.addEventListener('load', loadAllReviews);
    </script>
</body>
</html>
